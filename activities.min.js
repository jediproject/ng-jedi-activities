/*
 ng-jedi-activities v0.0.9
 Background tasks component written in angularjs
 https://github.com/jediproject/ng-jedi-activities
*/

!function(a){return"function"!=typeof define?("undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="jedi.activities"),a()):void define(["angular","moment","file-saver-saveas-js","angular-indexed-db"],a)}(function(){"use strict";function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}var b,c=[],d=[],e="hideMe",f="minimizeMe",g="activities",h=function(a,b){b.length>0&&(angular.forEach(b,function(b){i(a,function(a){return b.id===a.id},b)}),_.remove(a,function(a){return b[0].baseUrl?b[0].baseUrl===a.baseUrl&&!_.any(b,function(b){return b.id===a.id}):!1}))},i=function(a,b,c){if(_.any(a,b)){var d=_.find(a,b);_.merge(d,c)}else a.push(c)};angular.module("jedi.activities",["indexedDB"]).config(["$indexedDBProvider",function(a){a.connection("activities").upgradeDatabase(1,function(a,b,c){b.createObjectStore(g,{keyPath:"id"})})}]),angular.module("jedi.activities").constant("jedi.activities.ActivitiesConfig",{inProgressWarning:"You will lost {{count}} activities. Would you like to continue?",i18nDirective:"",title:"Activities",minimizeLabel:"Minimize",closeLabel:"Close",successLabel:"Success",stopLabel:"Stop",detailLabel:"Details",resultLabel:"Result",doneLabel:"Done",errorLabel:"Error",saveLabel:"Save",removeLabel:"Remove",refreshTime:1e4,clearAllLabel:"Clear All"}),angular.module("jedi.activities").service("jedi.activities.ActivitiesService",["$q","$http","$rootScope","$timeout","$interval","$indexedDB","$log","jedi.activities.ActivitiesConfig",function(e,f,j,k,l,m,n,o){function p(a){m.openStore(g,function(b){b.insert({id:a.id,activityItem:a}).then(function(a){n.info("Inserindo atividade id: "+a)})})}var q=this;this.initActivity=function(b,d,g,h,i,j,l){var m,n=moment.duration(),o=function(){n.add(1,"s"),q.duration="("+(n.hours()?n.hours()+":":"")+("0"+n.minutes()).slice(-2)+":"+("0"+n.seconds()).slice(-2)+")","progress"===q.status&&(m=k(o,1e3))},q={id:a(),name:i,status:"progress",duration:"(00:00)",userLoginHash:CryptoJS.MD5(j).toString(),async:!1,initialDate:Date.now()};c.unshift(q);var r={method:g.toUpperCase(),url:b+"/"+d,data:h,responseType:l?l:"arraybuffer",ignoreLoadingBar:!0,showLoadingModal:!1};k(o);var s=f(r).success(function(a,b,c,d){if("arraybuffer"===r.responseType.toLowerCase()||"blob"===r.responseType.toLowerCase()){var e=c("content-disposition"),f=e?e.substring(e.indexOf("filename=")+9):"";f&&(q.name=f),q.status="success",q.data=new Blob([a],{type:c("content-type")}),p(q)}else q.status="done",q.data=a,p(q)}).error(function(a,b){q.status="error",q.data=null,p(q)});return e.when(s.then(function(a){return{duration:n.asMilliseconds(),name:q.name,data:q.data,status:q.status}}))},this.initAsyncActivity=function(g,h,j,l,m,n){if(!b&&_.any(d,function(a){return-1!==a.indexOf(g)}))throw"Asynchronous activities must have a refresh url with the same baseUrl of activity. This must be set on loadAsyncActivities";var o,q=moment.duration(),r=function(){q.add(1,"s"),s.duration="("+(q.hours()?q.hours()+":":"")+("0"+q.minutes()).slice(-2)+":"+("0"+q.seconds()).slice(-2)+")","progress"===s.status&&(o=k(r,1e3))},s={id:a(),name:m,status:"progress",duration:"(00:00)",userLoginHash:CryptoJS.MD5(n).toString(),async:!0,initialDate:Date.now(),baseUrl:g};c.unshift(s);var t={method:j.toUpperCase(),url:g+"/"+h,data:l,ignoreLoadingBar:!0,showLoadingModal:!1};k(r);var u=f(t).success(function(a){a.data&&(i(c,function(b){return a.data.id===b.id},a.data),refresh())}).error(function(a,b){s.status="error",s.data=null,p(s)});return e.when(u.then(function(a){return{duration:q.asMilliseconds(),name:s.name,data:s.data,status:s.status}}))},this.loadAsyncActivities=function(a,e,g,i,j){var k={method:g.toUpperCase(),url:a+"/"+e,data:i,responseType:"json",ignoreLoadingBar:!0,showLoadingModal:!1};f(k).then(m,n),_.any(d,k)||d.push(k),b||(b=l(function(){angular.forEach(d,function(a){f(a).then(m,n)})},o.refreshTime));var m=function(b){var d=_.transform(b.data,function(b,c,d){b.push({id:c.id,name:c.name,status:c.status,userLoginHash:CryptoJS.MD5(j).toString(),async:!0,initialDate:new Date(c.initialDate).getTime(),baseUrl:a})},[]);h(c,d),c=_.sortByOrder(c,["initialDate"],["desc"]),q.refresh()},n=function(a){throw"Error when getting activities from server."}},this.clearAll=function(){j.$broadcast("jedi.activities.clearAll")},this.refresh=function(){j.$broadcast("jedi.activities.refresh")},this.toggle=function(){j.$broadcast("jedi.activities.toggleMonitor")},this.validateActivities=function(a){j.$broadcast("jedi.activities.validateActivities",a)},this.cancelRefreshActivities=function(){b||l.cancel(b)},this.hasInProgressActivities=function(){var a=0;return angular.forEach(c,function(b,c){"progress"===b.status&&a++}),a>0},this.hasActivities=function(){return c.length>0}}]).directive("jdActivity",["$log","$interpolate","jedi.activities.ActivitiesConfig",function(a,b,d){return{restrict:"E",replace:!0,link:function(a,g,h,i){a.$watch(function(){return c.length},function(a){if(a&&a>0){g.removeClass(e);var b=i.getInProgressItemsCount();b>0&&(g.removeClass(f),i.activitiesModel.minimize=!1)}else g.addClass(e)}),window.onbeforeunload=function(a){var c={count:i.getInProgressItemsCount()};return c.count>0?b(d.inProgressWarning)(c):void 0},a.$on("jedi.activities.clearAll",i.clearAll),a.$on("jedi.activities.toggleMonitor",i.toggle),a.$on("jedi.activities.refresh",i.refresh),a.$on("jedi.activities.validateActivities",i.validateActivities)},controller:["$scope","$attrs","$element","$timeout","$log","$indexedDB","$rootScope","$http","$window","jedi.dialogs.AlertHelper",function(a,b,d,h,i,j,k,l,m,n){function o(){a.activityItems=c}function p(a){if("progress"!=a.status&&!a.isRemoving)if(a.isRemoving=!0,i.info("Removendo item "+a.name),a.async){var b={method:"POST",url:a.baseUrl+"/"+a.hideApiUrl,ignoreLoadingBar:!0,showLoadingModal:!1};l.post(b).then(function(b){var d=c.indexOf(a);c.splice(d,1)},function(b){a.isRemoving=!1,i.error("Erro ao remover atividade "+a.name),i.error(b)})}else{var d=c.indexOf(a);c.splice(d,1),j.openStore(g,function(b){b["delete"](a.id)})}}function q(){var a=0;return angular.forEach(c,function(b,c){"progress"===b.status&&(!b.async||async&&b.async)&&a++}),a}function r(a){if("success"==a.status&&!a.isRemoving)if(a.isAsync){var b={method:"POST",url:a.baseUrl+"/"+a.downloadApiUrl,ignoreLoadingBar:!0,showLoadingModal:!1};l.post(b).then(function(b){i.info("Salvando item async "+a.name),saveAs(b,a.name)},function(a){})}else i.info("Salvando item "+a.name),saveAs(a.data,a.name)}function s(){i.info("Atualizando lista de itens"),a.activityItems=c}function t(){d.addClass(e)}function u(a){a.resultUrl&&m.open(a.resultUrl,"_blank")}function v(a){a.resultUrl&&m.open(a.detailsUrl,"_blank")}function w(a){n.confirm("Deseja realmente cancelar execução da atividade?",function(){i.debug("Cancelando execução da atividade "+a.name);var b={method:"POST",url:a.baseUrl+"/"+a.cancelApiUrl,ignoreLoadingBar:!0,showLoadingModal:!1};l.post(b).then(function(b){i.info("Atividade "+a.name+" cancelada com sucesso")},function(b){i.error("Erro ao cancelar atividade "+a.name),i.error(b)})})}function x(){return c&&c.length>0}function y(){i.info("Removendo lista de atividades");for(var a=c.length-1;a>=0;a--)p(c[a])}function z(){d.removeClass(e),d.removeClass(f)}function A(){d.hasClass(e)?z():t()}function B(a,b){j.openStore(g,function(a){a.getAll().then(function(d){angular.forEach(d,function(d){if(b){var e=CryptoJS.MD5(b.login).toString();if(d.activityItem.userLoginHash===e)return void c.push(d.activityItem)}a["delete"](d.id);for(var f=0;f<c.length;f++)c[f].id===d.id&&c.splice(f,1)})})})}i.info(c.length);var C=this;C.activitiesModel={minimize:!1},C.remove=p,C.save=r,C.refresh=s,C.close=t,C.result=u,C.cancel=w,C.detail=v,C.hasItemsToShow=x,C.clearAll=y,C.show=z,C.toggle=A,C.validateActivities=B,C.getInProgressItemsCount=q,o()}],controllerAs:"activitiesCtrl",bindToController:!0,templateUrl:function(a,b){return b.templateUrl?b.templateUrl:"assets/libs/ng-jedi-activities/activities.html"}}}]).run(["$templateCache","jedi.activities.ActivitiesConfig",function(a,b){var c='<div ng-class="{ minimizeMe: activitiesCtrl.activitiesModel.minimize }" class="animate-slide panel-default collapsable hideMe">    <div class="panel-heading activities-header">        <div class="row">            <div class="col-md-7 col-xs-7 col-sm-7 col-lg-7 pull-left activities-active" ng-click="activitiesCtrl.activitiesModel.minimize = !activitiesCtrl.activitiesModel.minimize">                <strong id="activitiesHeaderContent" class="activities-header-content">                    <i class="fa" ng-class="{ \'fa-spin\' : activitiesCtrl.activitiesModel.minimize && activitiesCtrl.getInProgressItemsCount() > 0, \'fa-cog\':  activitiesCtrl.activitiesModel.minimize && activitiesCtrl.getInProgressItemsCount() > 0, \'fa-tasks\': !activitiesCtrl.activitiesModel.minimize || (activitiesCtrl.activitiesModel.minimize && !activitiesCtrl.getInProgressItemsCount()) }"></i>                    <jd-i18n>                        '+b.title+'                    </jd-i18n>                </strong>            </div>            <div class="col-md-5 col-xs-5 col-sm-5 col-lg-5 text-right">                <span class="activities-active clear-all" jd-i18n title="Clear All" ng-click="activitiesCtrl.clearAll()">'+b.clearAllLabel+'</span>&nbsp;                <span class="glyphicon activities-active glyphicon-minus" jd-i18n title="'+b.minimizeLabel+'" ng-click="activitiesCtrl.activitiesModel.minimize = !activitiesCtrl.activitiesModel.minimize"></span>&nbsp;                <span class="glyphicon activities-active glyphicon-remove" jd-i18n title="'+b.closeLabel+'" ng-click="activitiesCtrl.close()"></span>            </div>        </div>    </div>    <div class="panel-body activities-scroll">        <div ng-repeat="item in activityItems track by item.id">            <div class="row" ng-class="{\'is-removing\' : item.isRemoving}">                <div class="col-md-9 col-xs-9 col-sm-9 col-lg-9 activities-content">                    <span>{{item.name}} {{item.duration}}</span>                    <span class="activities-progress" ng-if="item.status == \'progress\'"><i class="fa fa-cog fa-spin"></i></span>                    <span class="activities-done glyphicon glyphicon-ok" ng-if="item.status == \'success\'" jd-i18n title="'+b.successLabel+'"></span>                    <span class="activities-done glyphicon glyphicon-ok" ng-if="item.status == \'done\'" jd-i18n title="'+b.doneLabel+'"></span>                    <span class="activities-error glyphicon glyphicon-exclamation-sign" ng-if="item.status == \'error\'" jd-i18n title="'+b.errorLabel+'"></span>                    <span class="activities-error" ng-if="item.status == \'canceled\'" jd-i18n title="'+b.canceledLabel+'"><i class="fa fa-stop"></i></span>                </div>                <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3 text-right">                    <span class="activities-inactive glyphicon glyphicon-link" ng-if="item.status == \'done\' && item.resultUrl" ng-class="{\'activities-active\' : item.status == \'done\' }" jd-i18n title="'+b.resultLabel+'" ng-click="activitiesCtrl.result(item)"></span>                    <span class="activities-error glyphicon glyphicon-stop"    ng-if="item.status != \'done\' && item.cancelApiUrl" ng-class="{\'activities-inactive\' : item.status == \'done\' }" jd-i18n title="'+b.stopLabel+'" ng-click="activitiesCtrl.cancel(item)"></span>                    <span class="activities-active glyphicon glyphicon-search" ng-if="item.detailsUrl" jd-i18n title="'+b.detailLabel+'" ng-click="activitiesCtrl.detail(item)"></span>                    <span class="activities-inactive glyphicon glyphicon-save" ng-class="{\'activities-active\' : item.status == \'success\' || (item.status == \'done\' && item.downloadApiUrl) }" jd-i18n title="'+b.saveLabel+'" ng-click="activitiesCtrl.save(item)"></span>                    <span class="activities-inactive glyphicon glyphicon-remove" ng-class="{\'activities-active\' : item.status != \'progress\' }" jd-i18n title="'+b.removeLabel+'" ng-click="activitiesCtrl.remove(item)"></span>                </div>                <div class="col-md-1 col-xs-1 col-sm-1 col-lg-1">                </div>                <div class="col-md-1 col-xs-1 col-sm-1 col-lg-1">                </div>            </div>            <hr class="row activities-divider" />        </div>    </div></div>';b.i18nDirective&&(c=c.replace("jd-i18n",b.i18nDirective)),a.put("assets/libs/ng-jedi-activities/activities.html",c)}])});
//# sourceMappingURL=activities.min.map