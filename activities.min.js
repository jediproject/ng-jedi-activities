/*
 ng-jedi-activities v0.0.9
 Background tasks component written in angularjs
 https://github.com/jediproject/ng-jedi-activities
*/

!function(a){return"function"!=typeof define?("undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="jedi.activities"),a()):void define(["angular","moment","file-saver-saveas-js","angular-indexed-db"],a)}(function(){"use strict";function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}var b=[],c=[],d="hideMe",e="minimizeMe",f="activities";angular.module("jedi.activities",["indexedDB"]).config(["$indexedDBProvider",function(a){a.connection("activities").upgradeDatabase(1,function(a,b,c){b.createObjectStore(f,{keyPath:"id"})})}]),angular.module("jedi.activities").constant("jedi.activities.ActivitiesConfig",{inProgressWarning:"You will lost {{count}} activities. Would you like to continue?",i18nDirective:"",title:"Activities",minimizeLabel:"Minimize",closeLabel:"Close",successLabel:"Success",doneLabel:"Done",errorLabel:"Error",saveLabel:"Save",removeLabel:"Remove",clearAllLabel:"Clear All"}),angular.module("jedi.activities").service("jedi.activities.ActivitiesService",["$q","$http","$rootScope","$timeout","$indexedDB","$log",function(d,e,g,h,i,j){function k(a){i.openStore(f,function(b){b.insert({id:a.id,activityItem:a}).then(function(a){j.info("Inserindo atividade id: "+a)})})}this.initActivity=function(c,f,g,i,j,l,m){var n,o=moment.duration(),p=function(){o.add(1,"s"),q.duration="("+(o.hours()?o.hours()+":":"")+("0"+o.minutes()).slice(-2)+":"+("0"+o.seconds()).slice(-2)+")","progress"===q.status&&(n=h(p,1e3))},q={id:a(),name:j,status:"progress",duration:"(00:00)",userLoginHash:CryptoJS.MD5(l).toString(),async:!1};b.push(q);var r={method:g.toUpperCase(),url:c+"/"+f,data:i,responseType:m?m:"arraybuffer",ignoreLoadingBar:!0,showLoadingModal:!1};h(p);var s=e(r).success(function(a,b,c,d){if("arraybuffer"===r.responseType.toLowerCase()||"blob"===r.responseType.toLowerCase()){var e=c("content-disposition"),f=e?e.substring(e.indexOf("filename=")+9):"";f&&(q.name=f),q.status="success",q.data=new Blob([a],{type:c("content-type")}),k(q)}else q.status="done",q.data=a,k(q)}).error(function(a,b){q.status="error",q.data=null,k(q)});return d.when(s.then(function(a){return{duration:o.asMilliseconds(),name:q.name,data:q.data,status:q.status}}))},this.initAsyncActivity=function(f,g,i,j,l,m){if(_.some(c,function(a){return-1!==a.indexOf(f)}))throw"Asynchronous activities must have a refresh url with the same baseUrl of activity. This must be set on loadAsyncActivities";var n,o=moment.duration(),p=function(){o.add(1,"s"),q.duration="("+(o.hours()?o.hours()+":":"")+("0"+o.minutes()).slice(-2)+":"+("0"+o.seconds()).slice(-2)+")","progress"===q.status&&(n=h(p,1e3))},q={id:a(),name:l,status:"progress",duration:"(00:00)",userLoginHash:CryptoJS.MD5(m).toString(),async:!0,baseUrl:f};b.push(q);var r={method:i.toUpperCase(),url:f+"/"+g,data:j,ignoreLoadingBar:!0,showLoadingModal:!1};h(p);var s=e(r).error(function(a,b){q.status="error",q.data=null,k(q)});return d.when(s.then(function(a){return{duration:o.asMilliseconds(),name:q.name,data:q.data,status:q.status}}))},this.clearAll=function(){g.$broadcast("jedi.activities.clearAll")},this.toggle=function(){g.$broadcast("jedi.activities.toggleMonitor")},this.validateActivities=function(a){g.$broadcast("jedi.activities.validateActivities",a)},this.hasInProgressActivities=function(){var a=0;return angular.forEach(b,function(b,c){"progress"===b.status&&a++}),a>0},this.hasActivities=function(){return b.length>0}}]).directive("jdActivity",["$log","$interpolate","jedi.activities.ActivitiesConfig",function(a,c,g){return{restrict:"E",replace:!0,link:function(a,f,h,i){a.$watch(function(){return b.length},function(a){if(a&&a>0){f.removeClass(d);var b=i.getInProgressItemsCount();b>0&&(f.removeClass(e),i.activitiesModel.minimize=!1)}else f.addClass(d)}),window.onbeforeunload=function(a){var b={count:i.getInProgressItemsCount()};return b.count>0?c(g.inProgressWarning)(b):void 0},a.$on("jedi.activities.clearAll",i.clearAll),a.$on("jedi.activities.toggleMonitor",i.toggle),a.$on("jedi.activities.validateActivities",i.validateActivities)},controller:["$scope","$attrs","$element","$timeout","$log","$indexedDB","$rootScope","$http",function(a,c,g,h,i,j,k,l){function m(){a.activityItems=b}function n(a){if("progress"!=a.status&&!a.isRemoving)if(a.isRemoving=!0,i.info("Removendo item "+a.name),a.isAsync){var c={method:"POST",url:a.baseUrl+"/"+a.hideApiUrl,ignoreLoadingBar:!0,showLoadingModal:!1};l.post(c).then(function(c){var d=b.indexOf(a);b.splice(d,1)},function(a){})}else{var d=b.indexOf(a);b.splice(d,1),j.openStore(f,function(b){b["delete"](a.id)})}}function o(){var a=0;return angular.forEach(b,function(b,c){"progress"===b.status&&a++}),a}function p(a){"success"!=a.status||a.isRemoving||(i.info("Salvando item "+a.name),saveAs(a.data,a.name))}function q(){i.info("Atualizando lista de itens")}function r(){g.addClass(d)}function s(){return b&&b.length>0}function t(){i.info("Removendo lista de atividades");for(var a=b.length-1;a>=0;a--)n(b[a])}function u(){g.removeClass(d),g.removeClass(e)}function v(){g.hasClass(d)?u():r()}function w(a,c){j.openStore(f,function(a){a.getAll().then(function(d){angular.forEach(d,function(d){if(c){var e=CryptoJS.MD5(c.login).toString();if(d.activityItem.userLoginHash===e)return void b.push(d.activityItem)}a["delete"](d.id);for(var f=0;f<b.length;f++)b[f].id===d.id&&b.splice(f,1)})})})}i.info(b.length);var x=this;x.activitiesModel={minimize:!1},x.remove=n,x.saveIconClick=p,x.refresh=q,x.close=r,x.hasItemsToShow=s,x.clearAll=t,x.show=u,x.toggle=v,x.validateActivities=w,x.getInProgressItemsCount=o,m()}],controllerAs:"activitiesCtrl",bindToController:!0,templateUrl:function(a,b){return b.templateUrl?b.templateUrl:"assets/libs/ng-jedi-activities/activities.html"}}}]).run(["$templateCache","jedi.activities.ActivitiesConfig",function(a,b){var c='<div ng-class="{ minimizeMe: activitiesCtrl.activitiesModel.minimize }" class="animate-slide panel-default collapsable hideMe">    <div class="panel-heading activities-header">        <div class="row">            <div class="col-md-7 col-xs-7 col-sm-7 col-lg-7 pull-left activities-active" ng-click="activitiesCtrl.activitiesModel.minimize = !activitiesCtrl.activitiesModel.minimize">                <strong id="activitiesHeaderContent" class="activities-header-content">                    <i class="fa" ng-class="{ \'fa-spin\' : activitiesCtrl.activitiesModel.minimize && activitiesCtrl.getInProgressItemsCount() > 0, \'fa-cog\':  activitiesCtrl.activitiesModel.minimize && activitiesCtrl.getInProgressItemsCount() > 0, \'fa-tasks\': !activitiesCtrl.activitiesModel.minimize || (activitiesCtrl.activitiesModel.minimize && !activitiesCtrl.getInProgressItemsCount()) }"></i>                    <jd-i18n>                        '+b.title+'                    </jd-i18n>                </strong>            </div>            <div class="col-md-5 col-xs-5 col-sm-5 col-lg-5 text-right">                <span class="activities-active clear-all" jd-i18n title="Clear All" ng-click="activitiesCtrl.clearAll()">'+b.clearAllLabel+'</span>&nbsp;                <span class="glyphicon activities-active glyphicon-minus" jd-i18n title="'+b.minimizeLabel+'" ng-click="activitiesCtrl.activitiesModel.minimize = !activitiesCtrl.activitiesModel.minimize"></span>&nbsp;                <span class="glyphicon activities-active glyphicon-remove" jd-i18n title="'+b.closeLabel+'" ng-click="activitiesCtrl.close()"></span>            </div>        </div>    </div>    <div class="panel-body activities-scroll">        <div ng-repeat="item in activityItems track by item.id">            <div class="row" ng-class="{\'is-removing\' : item.isRemoving}">                <div class="col-md-9 col-xs-9 col-sm-9 col-lg-9 activities-content">                    <span>{{item.name}} - {{item.duration}}</span>                </div>                <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3 text-right">                    <span class="activities-progress" ng-if="item.status == \'progress\'"><i class="fa fa-cog fa-spin"></i></span>                    <span class="activities-done glyphicon glyphicon-ok" ng-if="item.status == \'success\'" jd-i18n title="'+b.successLabel+'"></span>                    <span class="activities-done glyphicon glyphicon-ok" ng-if="item.status == \'done\'" jd-i18n title="'+b.doneLabel+'"></span>                    <span class="activities-error glyphicon glyphicon-exclamation-sign" ng-if="item.status == \'error\'" jd-i18n title="'+b.errorLabel+'"></span>                    <span class="activities-inactive glyphicon glyphicon-save" ng-class="{\'activities-active\' : item.status == \'success\' }" jd-i18n title="'+b.saveLabel+'" ng-click="activitiesCtrl.saveIconClick(item)"></span>                    <span class="activities-inactive glyphicon glyphicon-remove" ng-class="{\'activities-active\' : item.status != \'progress\' }" jd-i18n title="'+b.removeLabel+'" ng-click="activitiesCtrl.remove(item)"></span>                </div>                <div class="col-md-1 col-xs-1 col-sm-1 col-lg-1">                </div>                <div class="col-md-1 col-xs-1 col-sm-1 col-lg-1">                </div>            </div>            <hr class="row activities-divider" />        </div>    </div></div>';b.i18nDirective&&(c=c.replace("jd-i18n",b.i18nDirective)),a.put("assets/libs/ng-jedi-activities/activities.html",c)}])});
//# sourceMappingURL=activities.min.map